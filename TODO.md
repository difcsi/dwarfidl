# Merge grammars

The dwarfidl language has a complicated history, and remains something
of a mess. Originally, dwarfidl was a fragment of the Cake language. It
was born as a separate entity in 2011 by isolating the part of that
language used to describe binary interfaces by augmentation of (or
substitution for missing) debugging information.

The Cake-derived grammar was modified in 2014 (ed95f92) to yield what is
now called the 'dwarfidlSimple' grammar, intended to temporarily replace
the Cake-derived one and to be more uniform (intending improvements to
be back-ported, but this still hasn't happened). This is the grammar
used by liballocs to describe composite types implied by code like
`malloc(sizeof (T) + sizeof (S))`, processed by the `create_dies`
function. There is an unfinished dumper in this syntax, `dwarfidldump`,
in examples/ and the underlying print code is in src/print.cpp. Examples
of the syntax can be generated by liballocs's tools in the '.allocs'
files; after building liballocs, see
`/usr/lib/meta/path/to/liballocs/tests/offsetof/offsetof.allocs` for one
example.

In 2015 Jon French wrote a new grammar to serve the libfootprints
project, which consists of tools for specifying and checking the memory
access footprints of system calls and the like. This grammar is now
called 'dwarfidlNew' and its last significant changes were in 50ca031.
The printing code is in src/dwarfprint.cpp and does work. A test case
called `dwarfprint' (added in 2020) exercises this code. A sample of the
syntax as dumped is in tests/dwarfprint/sample-output.txt.

A long-neglected goal has been to unite these two strands, possibly
as part of publishing the libfootprints work.

## Summary of language grammars, parsers and printers

| syntax |  print code        | test/example dumper       | example syntax                     |
|--------|--------------------|---------------------------|------------------------------------||
| simple | src/print.cpp      | examples/dwarfidldump.cpp | see liballocs                      |
| new    | src/dwarfprint.cpp | tests/dwarfprint          | tests/dwarfprint/sample-output.txt |

# Augmenters

One problem with DWARF that comes out of compilers is that it omits some details, such as
those implied by the calling convention. It's be good for dwarfidl descriptions to include
these details, and that means recovering them by means other than simply reading what the
compiler generated... in short we'd like other ways of obtaining information and merging it
together.

DWARF augmenters can work at the dwarfidl (text) or libdwarfpp (binary) level, but dwarfidl
seems a reasonable place to keep them either way.

* Here "text" means "generate dwarfidl
source". In liballocs, the dumpallocs CIL tool can (just about) be considered a
dwarfidl-generating augmenter, because it generates dwarfidl syntax. This is merged in by
one of the other tools.

* Meanwhile, "binary" means adding DIEs to a libdwarfpp `root_die` data structure;
liballocstool does some of this, including

** using dwarfidl's `create_dies()` for the synthetic
** turning the text into binary DIEs
** creating the DIEs for void, for void* as existentially quantified generic pointer, etc.

Other augmenters we want:

 * calling convention augmenter of location exprs
 * back-propagator for kernel interface DWARF (if kernel still does typeinfo-erasure)
 * call site augmenter for syscall sites, including "constant argument" info
 * (ideally) call site augmenter for allocation sites -- to add the type info from `dumpallocs`

(SK: see also my mail to Guillaume of Wed, 29 May 2019.)

What's the best way to do augmenters? is "generate textual dwarfidl" a good way?

* `create_dies()` is OK for things that fit best in a separate compilation unit (CU),
less when they need to be mindled in an existing CU.
* whereas e.g. the backpropagator may want intra-CU additions
** for this, need to refactor libdwarfpp e.g. to have rational offsets

# Related libdwarfpp changes

* migation to libdw
* switch from `Dwarf_Off` to rational offsets, to allow insertion without breaking order invariants

# dwarfidl changes
DONE: merge changes on ernest-6 dwarfidl.hg
DONE: parser and printer stock-taking (did Jon make a general dumper + parser? yes)
DONE: clarify which grammar is which:  ("Simple" is old / Cake-derived, "New" is Jon's)
DONE: printer: make it print a whole big file
SKIP: parser merging
